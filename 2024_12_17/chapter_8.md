## 평가 루프

##### 컴파일까지 하고 나면 코드 객체가 생성된다
##### 이러한 코드 객체는 입력이 있어야 실행 할 수 있다.
##### 컴파일된 코드 객체에서 바이트코드 연산들은 값 스택에서 변수를 생성하고 변경, 사용한다.

![alt text](image.png)

##### - 평가 루프는 코드 객체를 입력받아 이련의 프레임 객체를 변환한다.
##### - 인터프리터는 최소 한개의 스레드를 가진다.
##### - 각 스레드는 스레드 상태를 가진다.
##### - 프레임 객체는 프레임 스택에서 실행된다.
##### - 값 스택에서 변수를 참조할 수 있다.

### 8.1 스레드 상태 생성하기

##### 프레임을 실행하려면 스레드에 연결해야 한다.

#### 8.1.1 스레드 상태

##### PyThreadState 스레드 상태 타입은 서른개가 넘는 프로퍼티를 가지고 있다.
##### 고유 식별자
##### 다른 스레드 상태와 연결된 연결 리스트
##### 현재 실행 중인 프레임
##### 현재 재귀 깊이
##### 선택적 추적 함수들
##### 현재 처리 중인 예외
##### 현재 처리 중인 비동기 예외
##### 여러 예외가 발생할 때의 예외 스택
##### GIL(global interpreter lock) 카운터
##### 비동기 제너레이터 카운터

#### 8.1.2 연관된 소스 파일 목록

##### Python/thread.c : 스레드 API 구현
##### Include/threadstate.h : 스레드 상태 API와 타입 정의
##### Include/pystate.h : 인터프리터 상태 API와 타입 정의
##### Include/pythread.h : 스레딩 API
##### Include/cpython/pystate.h : 스레드와 인터프리터 상태 API

***

### 8.2 프레임 객체 생성하기

##### 컴파일된 코드 객체는 프레임 객체에 삽입된다.
##### 프레임 객체는 코드 객체의 명령을 실행하는데 필요한 런타임 데이터를 포함한다. (전역, 지역변수, 내장 모듈)

#### 8.2.1 프레임 객체

![alt text](image-1.png)

#### 8.2.2 연관된 소스 파일 목록

##### Objects/frameobject.c : 프레임 객체 구현과 파이썬 API
##### Include/frameobject.h : 프레임 객체 API와 타입 정의

#### 8.2.3 프레임 객체 초기화 API

```
/* Python/ceval.c */

_PyEval_EvalCode(PyThreadState *tstate,
           PyObject *_co, PyObject *globals, PyObject *locals,
           PyObject *const *args, Py_ssize_t argcount,
           PyObject *const *kwnames, PyObject *const *kwargs,
           Py_ssize_t kwcount, int kwstep,
           PyObject *const *defs, Py_ssize_t defcount,
           PyObject *kwdefs, PyObject *closure,
           PyObject *name, PyObject *qualname)

```

##### tstate : 코드를 평가할 스레드의 상태를 나타냄
##### _co : 프레임 객체에 삽입할 코드 객체
##### globals : 전역 변수, 변수명을 키로 사용
##### lcoals : 지역 변수, 변수명을 키로 사용

##### 주요 흐름
##### 1. 스레드 상태가 유효한지 확인한다.
##### 2. 프레임 객체를 선언하고 그 반환값을 초기화하는 등 초기화 작업을 진행한다.
##### 3. 프레임 객체를 생성한다.
##### 4. 인자와 변수를 처리한다.
##### 5. 제너레이터 객체와 코루틴 객체를 처리한다.
##### 6. 프레임을 실행하고 결과를 저장한다.
##### 7. 프레임 객체의 참조 수를 확인하고 관련 객체들을 해제한다.
##### 8. 결과를 반환한다.

![alt text](image-2.png)

***

### 8.3 프레임 실행

##### _PyEval_EvalFrameDefault()는 기본 프레임 평가함수이며, 이 함수가 모든것을 통합하는 역할을 수행합니다.
##### 간단히 말해, 파이썬 프로그램이 실행될 때, 각각의 코드 객체는 실행을 위해 '프레임'이라는 단위로 관리되고 _PyEval_EvalFrameDefault()는 이러한 프레임들을 하나씩 받아서 순차적으로 명령을 실행하게 됩니다.

#### 8.3.1 프레임 실행 추적

***

### 8.4 값 스택

#### 8.4.1 바이트코드 명령 예제: BINARY_OR

#### 8.4.2 값 스택 시뮬레이션

#### 8.4.3 스택 효과

***

### 8.5 예제: 리스트에 요소를 추가하기